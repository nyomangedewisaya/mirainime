---
import DonghuaCard from '../../cards/DonghuaCard.astro';
import RankingItem from '../../cards/RankingItem.astro';
import { Icon } from 'astro-icon/components';
import { fetchFromAniList } from '../../../lib/anilist';

interface Props {
  variables: any;
}
const { variables } = Astro.props;

const EXPLORE_QUERY = `
  query GetExploreData {
    trending: Page(page: 1, perPage: 10) {
      media(sort: TRENDING_DESC, type: ANIME, countryOfOrigin: "CN", isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
      }
    }
    
    popularAiring: Page(page: 1, perPage: 10) {
      media(sort: POPULARITY_DESC, type: ANIME, countryOfOrigin: "CN", status: RELEASING, isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
      }
    }
    
    upcoming: Page(page: 1, perPage: 10) {
      media(sort: POPULARITY_DESC, type: ANIME, countryOfOrigin: "CN", status: NOT_YET_RELEASED, isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
      }
    }
    
    topRanking: Page(page: 1, perPage: 10) {
      media(sort: SCORE_DESC, type: ANIME, countryOfOrigin: "CN", isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
        genres
        format
        episodes
        duration
        season
        seasonYear
        status
        studios(isMain: true) {
          nodes { name }
        }
      }
    }
  }
`;
const data = await fetchFromAniList({ query: EXPLORE_QUERY });

const trendingDonghua = data?.trending?.media || [];
const popularDonghua = data?.popularAiring?.media || [];
const upcomingDonghua = data?.upcoming?.media || [];
const topDonghua = data?.topRanking?.media || [];

const formatEpisodesInfo = (format: string, episodes: number, duration: number) => {
  if (format === 'MOVIE') return duration ? `${duration} mins` : 'Unknown duration';
  return episodes ? `${episodes} Episodes` : 'Unknown eps';
};

const formatFormatText = (format: string) => {
  if (!format) return 'Unknown';
  if (format === 'TV_SHORT') return 'TV Short';
  return format.replace('_', ' ');
};

const formatSeasonText = (season: string, year: number) => {
  if (!season || !year) return 'TBA';
  return `${season.charAt(0) + season.slice(1).toLowerCase()} ${year}`;
};

const formatStatusText = (status: string) => {
  if (!status) return 'Unknown';
  if (status === 'NOT_YET_RELEASED') return 'Not Yet Released';
  return status.charAt(0) + status.slice(1).toLowerCase();
};

const getTitle = (titleObj: any) => titleObj.english || titleObj.romaji;
---

<div class="flex flex-col gap-16 w-full fade-in-swap">
  <section>
    <div class="flex items-end justify-between mb-6">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
        <span class="w-1.5 h-6 bg-primary-500 rounded-full"></span> Trending Now
      </h2>
      <a href="/donghua/trending" class="text-md font-medium text-primary-500 hover:text-primary-600 transition-colors hover:underline">View All</a>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
      {trendingDonghua.map((donghua: any) => (
        <DonghuaCard
          id={donghua.id}
          title={getTitle(donghua.title)}
          image={donghua.coverImage.large}
        />
      ))}
    </div>
  </section>

  <section>
    <div class="flex items-end justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
          <span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span> Popular Airing Now
        </h2>
      </div>
      <a href="/donghua/airing" class="text-md font-medium text-primary-500 hover:text-primary-600 transition-colors hover:underline">View All</a>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
      {popularDonghua.map((donghua: any) => (
        <DonghuaCard
          id={donghua.id}
          title={getTitle(donghua.title)}
          image={donghua.coverImage.large}
        />
      ))}
    </div>
  </section>

  <section>
    <div class="flex items-end justify-between mb-6">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
        <span class="w-1.5 h-6 bg-emerald-500 rounded-full"></span> Highly Anticipated
      </h2>
      <a href="/donghua/upcoming" class="text-md font-medium text-primary-500 hover:text-primary-600 transition-colors hover:underline">View All</a>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
      {upcomingDonghua.map((donghua: any) => (
        <DonghuaCard
          id={donghua.id}
          title={getTitle(donghua.title)}
          image={donghua.coverImage.large}
        />
      ))}
    </div>
  </section>

  <section class="mx-auto w-full">
    <div class="flex items-end justify-between mb-8 pb-4 border-b border-slate-200 dark:border-slate-800">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
        <Icon name="lucide:trophy" class="w-6 h-6 text-primary-500" /> All-Time Top Ranking 100
      </h2>
      <a href="/donghua/top-100" class="text-md font-medium text-primary-500 transition-colors hover:underline">View All Ranking</a>
    </div>
    <div class="flex flex-col gap-2">
      {topDonghua.map((donghua: any, index: number) => (
        <RankingItem
          id={donghua.id}
          rank={index + 1}
          title={getTitle(donghua.title)}
          image={donghua.coverImage.large}
          genres={donghua.genres || []}
          studio={donghua.studios?.nodes?.[0]?.name || 'Unknown Studio'}
          format={formatFormatText(donghua.format)}
          episodes={formatEpisodesInfo(donghua.format, donghua.episodes, donghua.duration)}
          season={formatSeasonText(donghua.season, donghua.seasonYear)}
          status={formatStatusText(donghua.status)}
        />
      ))}
    </div>
  </section>

</div>