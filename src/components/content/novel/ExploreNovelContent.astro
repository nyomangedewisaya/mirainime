---
import NovelCard from '../../cards/NovelCard.astro';
import { fetchFromAniList } from '../../../lib/anilist';

const EXPLORE_QUERY = `
  query GetExploreNovel {
    trending: Page(page: 1, perPage: 10) {
      media(sort: TRENDING_DESC, type: MANGA, format: NOVEL, isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
      }
    }
    
    popular: Page(page: 1, perPage: 10) {
      media(sort: POPULARITY_DESC, type: MANGA, format: NOVEL, isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
      }
    }

    topRated: Page(page: 1, perPage: 10) {
      media(sort: SCORE_DESC, type: MANGA, format: NOVEL, isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
      }
    }
    
    releasing: Page(page: 1, perPage: 10) {
      media(sort: UPDATED_AT_DESC, type: MANGA, format: NOVEL, status: RELEASING, isAdult: false) {
        id
        title { romaji english }
        coverImage { large }
      }
    }
  }
`;

const data = await fetchFromAniList({ query: EXPLORE_QUERY });

const trendingNovel = data?.trending?.media || [];
const popularNovel = data?.popular?.media || [];
const topRatedNovel = data?.topRated?.media || [];
const releasingNovel = data?.releasing?.media || [];

const getTitle = (titleObj: any) => titleObj.english || titleObj.romaji;
---

<div class="flex flex-col gap-16 w-full fade-in-swap">
  
  <section>
    <div class="flex items-end justify-between mb-6">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
        <span class="w-1.5 h-6 bg-primary-500 rounded-full"></span> Trending Now
      </h2>
      <a href="/novel/trending" class="text-md font-medium text-primary-500 hover:text-primary-600 transition-colors hover:underline">View All</a>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
      {trendingNovel.map((novel: any) => (
        <NovelCard 
          id={novel.id}
          title={getTitle(novel.title)} 
          image={novel.coverImage.large} 
        />
      ))}
    </div>
  </section>

  <section>
    <div class="flex items-end justify-between mb-6">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
        <span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span> All-Time Popular
      </h2>
      <a href="/novel/popular" class="text-md font-medium text-primary-500 hover:text-primary-600 transition-colors hover:underline">View All</a>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
      {popularNovel.map((novel: any) => (
        <NovelCard 
          id={novel.id}
          title={getTitle(novel.title)} 
          image={novel.coverImage.large} 
        />
      ))}
    </div>
  </section>

  <section>
    <div class="flex items-end justify-between mb-6">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
        <span class="w-1.5 h-6 bg-emerald-500 rounded-full"></span> Recently Releasing
      </h2>
      <a href="/novel/releasing" class="text-md font-medium text-primary-500 hover:text-primary-600 transition-colors hover:underline">View All</a>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
      {releasingNovel.map((novel: any) => (
        <NovelCard 
          id={novel.id}
          title={getTitle(novel.title)} 
          image={novel.coverImage.large} 
        />
      ))}
    </div>
  </section>

</div>