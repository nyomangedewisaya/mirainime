---
import DetailHero from '../../detail/DetailHero.astro';
import DetailInfoGrid from '../../detail/DetailInfoGrid.astro';
import DetailTags from '../../detail/DetailTags.astro';
import DetailCharacters from '../../detail/DetailCharacters.astro';
import { fetchFromAniList } from '../../../lib/anilist';
import DetailRelations from '../../detail/DetailRelations.astro';
import DetailTrailer from '../../detail/DetailTrailer.astro';

interface Props {
  id: string;
}

const { id } = Astro.props;

const AENI_DETAIL_QUERY = `
  query ($id: Int) {
    Media(id: $id, type: ANIME) {
      id
      title { romaji english native }
      description(asHtml: false)
      bannerImage
      coverImage { extraLarge large medium }
      genres
      source
      format
      episodes
      duration
      status
      startDate { year month day }
      endDate { year month day }
      season
      seasonYear
      averageScore
      meanScore
      popularity
      favourites
      rankings { rank type context year season allTime }
      studios { edges { isMain node { name } } }
      tags { name rank }
      nextAiringEpisode { episode timeUntilAiring }
      characters(sort: ROLE) {
        edges {
          role
          node { 
            id   
            name { full } 
            image { medium } 
          }
          voiceActors(language: KOREAN) { 
            id   
            name { full } 
            image { medium } 
          }
        }
      }
      relations {
        edges {
          relationType
          node {
            id
            type
            format
            status
            countryOfOrigin
            title { romaji english }
            coverImage { large }
          }
        }
      }
      trailer {
        id
        site
        thumbnail
      }
    }
  }
`;

const data = await fetchFromAniList({ 
  query: AENI_DETAIL_QUERY, 
  variables: { id: parseInt(id, 10) } 
});

const aeni = data?.Media;

if (!aeni) {
  return Astro.redirect('/404');
}
---

<div class="w-full flex flex-col fade-in-swap">
  <DetailHero anime={aeni} type="aeni" />
  <DetailInfoGrid anime={aeni} />
  
  {aeni.tags && aeni.tags.length > 0 && (
    <DetailTags tags={aeni.tags} />
  )}
  
  {aeni.relations && aeni.relations.edges.length > 0 && (
    <DetailRelations relations={aeni.relations} />
  )}
  
  {aeni.characters && aeni.characters.edges.length > 0 && (
    <DetailCharacters characters={aeni.characters} />
  )}

  {aeni.trailer && aeni.trailer.site === "youtube" && (
    <DetailTrailer trailer={aeni.trailer} />
  )}
</div>