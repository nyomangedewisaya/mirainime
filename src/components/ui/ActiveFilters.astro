---
import { Icon } from 'astro-icon/components';

interface Props {
  defaultSeason?: string;
  defaultYear?: string | number;
  defaultStatus?: string;
}

const { defaultSeason, defaultYear, defaultStatus } = Astro.props;
const sp = Astro.url.searchParams;

interface Chip {
  id: string;
  display: string;
  keys: string[];
  valToRemove?: string;
  icon?: string;
  isRemovable?: boolean;
}

const chips: Chip[] = [];

if (sp.has('search')) chips.push({ id: 'search', display: `Search: ${sp.get('search')}`, keys: ['search'], icon: 'lucide:search' });
if (sp.has('genre')) chips.push({ id: 'genre', display: `Genre: ${sp.get('genre')}`, keys: ['genre'] });

if (sp.has('season')) {
  chips.push({ id: 'season', display: `Season: ${sp.get('season')}`, keys: ['season'] });
} else if (defaultSeason) {
  chips.push({ id: 'season', display: `Season: ${defaultSeason}`, keys: ['season'], isRemovable: false });
}

if (sp.has('year')) {
  chips.push({ id: 'year', display: `Year: ${sp.get('year')}`, keys: ['year'] });
} else if (defaultYear) {
  chips.push({ id: 'year', display: `Year: ${defaultYear}`, keys: ['year'], isRemovable: false });
}

if (sp.has('status')) {
  chips.push({ id: 'status', display: `Status: ${sp.get('status')?.replace(/_/g, ' ')}`, keys: ['status'] });
} else if (defaultStatus) {
  chips.push({ id: 'status', display: `Status: ${defaultStatus.replace(/_/g, ' ')}`, keys: ['status'], isRemovable: false });
}

if (sp.has('format')) chips.push({ id: 'format', display: `Format: ${sp.get('format')?.replace(/_/g, ' ')}`, keys: ['format'] });
if (sp.has('countryOfOrigin')) chips.push({ id: 'country', display: `Country: ${sp.get('countryOfOrigin')}`, keys: ['countryOfOrigin'] });
if (sp.has('source')) chips.push({ id: 'source', display: `Source: ${sp.get('source')?.replace(/_/g, ' ')}`, keys: ['source'] });
if (sp.has('streaming')) chips.push({ id: 'streaming', display: `${sp.get('streaming')}`, keys: ['streaming'], icon: 'lucide:tv' });

if (sp.has('tags')) {
  const tagVals = sp.get('tags')?.split(',') || [];
  tagVals.forEach(t => {
    if (t.trim()) chips.push({ id: `tag-${t}`, display: t.trim(), keys: ['tags'], valToRemove: t.trim(), icon: 'lucide:tag' });
  });
}

const yMin = sp.get('startDate_greater')?.replace('0000', '');
const yMax = sp.get('startDate_lesser')?.replace('1232', '');
if (yMin || yMax) {
  let disp = 'Year: ';
  if (yMin && yMax) disp += `${yMin} - ${yMax}`;
  else if (yMin) disp += `≥ ${yMin}`;
  else if (yMax) disp += `≤ ${yMax}`;
  chips.push({ id: 'range-year', display: disp, keys: ['startDate_greater', 'startDate_lesser'], icon: 'lucide:calendar-range' });
}

const epMin = sp.get('episodes_greater');
const epMax = sp.get('episodes_lesser');
if (epMin || epMax) {
  let disp = 'Episodes: ';
  if (epMin && epMax) disp += `${epMin} - ${epMax}`;
  else if (epMin) disp += `≥ ${epMin}`;
  else if (epMax) disp += `≤ ${epMax}`;
  chips.push({ id: 'range-ep', display: disp, keys: ['episodes_greater', 'episodes_lesser'], icon: 'lucide:list-video' });
}

const durMin = sp.get('duration_greater');
const durMax = sp.get('duration_lesser');
if (durMin || durMax) {
  let disp = 'Duration: ';
  if (durMin && durMax) disp += `${durMin} - ${durMax} min`;
  else if (durMin) disp += `≥ ${durMin} min`;
  else if (durMax) disp += `≤ ${durMax} min`;
  chips.push({ id: 'range-dur', display: disp, keys: ['duration_greater', 'duration_lesser'], icon: 'lucide:clock' });
}

const hasChips = chips.length > 0;
---

{hasChips && (
  <div class="container mx-auto mt-4 px-4 lg:px-8 mb-6 animate-in fade-in slide-in-from-top-2 duration-300">
    <div class="flex flex-wrap items-center gap-2.5">
      
      {chips.map(chip => (
        <div class="group inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[13px] font-medium bg-white dark:bg-primary-600 text-slate-600 dark:text-white border border-slate-200 dark:border-white shadow-sm transition-all hover:shadow-md hover:border-primary-300 dark:hover:border-primary-700">
          
          {chip.icon && <Icon name={chip.icon} class="w-3.5 h-3.5 opacity-70" />}
          
          <span class="max-w-37.5 md:max-w-xs truncate capitalize">{chip.display}</span>
          
          {chip.isRemovable !== false && (
            <button 
              class="btn-remove-chip ml-1 p-0.5 rounded-full text-primary-500 dark:text-white hover:bg-red-500 hover:text-white dark:hover:bg-red-600 transition-colors focus:outline-none cursor-pointer"
              data-keys={chip.keys.join(',')} 
              data-val={chip.valToRemove || ''}
              aria-label={`Remove ${chip.display} filter`}
            >
              <Icon name="lucide:x" class="w-3.5 h-3.5" />
            </button>
          )}
        </div>
      ))}

      {chips.length > 1 && (
        <button id="btn-clear-all-chips" class="text-xs font-semibold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 ml-2 underline underline-offset-4 transition-colors cursor-pointer">
          Clear All
        </button>
      )}

    </div>
  </div>
)}

<script>
  const initActiveChips = () => {
    document.querySelectorAll('.btn-remove-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        const url = new URL(window.location.href);
        const keys = (btn as HTMLElement).dataset.keys!.split(',');
        const valToRemove = (btn as HTMLElement).dataset.val;

        keys.forEach(k => {
          if (k === 'tags' && valToRemove) {
            let currentTags = url.searchParams.get('tags')?.split(',') || [];
            currentTags = currentTags.filter(t => t !== valToRemove);
            if (currentTags.length > 0) {
              url.searchParams.set('tags', currentTags.join(','));
            } else {
              url.searchParams.delete('tags');
            }
          } else {
            url.searchParams.delete(k);
          }
        });

        url.searchParams.delete('page');
        window.location.assign(url.toString());
      });
    });

    const clearAllBtn = document.getElementById('btn-clear-all-chips');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', () => {
        window.location.href = window.location.pathname;
      });
    }
  };

  initActiveChips();
</script>